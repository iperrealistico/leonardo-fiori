<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ============================================ -->
    <!-- CONFIGURATION SECTION - EDIT VALUES BELOW    -->
    <!-- ============================================ -->
    
    <!-- Basic Site Information -->
    <title>Leonardo Fiori</title>
    <meta name="description" content="Portfolio showcasing artistic work by Leonardo Fiori, photographer and artist based in Italy">
    <meta name="author" content="Leonardo Fiori">
    
    <!-- SEO and Social Media -->
    <meta property="og:title" content="Leonardo Fiori">
    <meta property="og:description" content="Portfolio showcasing artistic work by Leonardo Fiori, photographer and artist based in Italy">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.leonardofiori.it">
    <meta property="og:image" content="https://www.leonardofiori.it/home/img/img1.jpg">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- Favicon - Multiple formats for better compatibility -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="icon" type="image/ico" href="favicon.ico">
    <link rel="shortcut icon" href="favicon.ico?">
    
    <!-- Critical inline styles for immediate preloader display -->
    <style>
        /* Critical preloader styles - inline for immediate display */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .page-preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .preloader-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #d0d0d0;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Main styles -->
    <style>
        :root {
            /* EDIT THESE VALUES TO CUSTOMIZE APPEARANCE */
            --background-color: #ffffff;
            --text-color: #000000;
            --font-family: 'Crimson Text', serif; /* Google Font name */
            --font-size: 18px;
            --line-height: 1.6;
            --footer-text: '© 2025 Leonardo Fiori. All rights reserved.'; /* Edit footer text */
            --site-title: 'Leonardo Fiori'; /* Edit site title that appears in navigation */
            --nav-height: 60px;
            --transition-duration: 0.5s;
            --text-position: 'below'; /* 'above' or 'below' - position of text relative to images */
            --external-links-new-tab: true; /* true or false - open external links in new tab */
        }
        
        /* Fade out animation for preloader */
        .page-preloader.fade-out {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        
        /* Main content hidden initially and fades in */
        .main-wrapper {
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }
        
        .main-wrapper.fade-in {
            opacity: 1;
        }
        
        /* Allow scrolling when loaded */
        body.loaded {
            overflow: visible;
        }
        
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: var(--font-size);
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-family);
            color: var(--text-color);
            background-color: var(--background-color);
            line-height: var(--line-height);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--background-color);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
        }
        
        .nav-container {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .nav-item {
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
            transition: opacity var(--transition-duration);
            font-weight: 400;
            position: relative;
            outline: none;
        }
        
        .nav-item:hover {
            opacity: 0.6;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 1px;
            background-color: var(--text-color);
        }
        
        .nav-item.external::after {
            content: '↗';
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8em;
        }
        
        /* Site Title */
        .site-title {
            font-size: 1.5em;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
            transition: opacity var(--transition-duration);
            outline: none;
        }
        
        .site-title::before {
            content: var(--site-title);
        }
        
        .site-title:hover {
            opacity: 0.7;
        }
        
        /* Mobile Menu */
        .hamburger {
            display: none;
            width: 30px;
            height: 24px;
            position: relative;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            outline: none;
        }
        
        .hamburger span {
            display: block;
            position: absolute;
            height: 2px;
            width: 100%;
            background: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .hamburger span:nth-child(1) {
            top: 0;
        }
        
        .hamburger span:nth-child(2) {
            top: 11px;
        }
        
        .hamburger span:nth-child(3) {
            bottom: 0;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg);
            top: 11px;
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg);
            bottom: 11px;
        }
        
        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 999;
        }
        
        .mobile-menu.active {
            opacity: 1;
            visibility: visible;
        }
        
        .mobile-menu .nav-item {
            font-size: 1.5em;
            display: block;
            position: relative;
        }
        
        /* Main Content */
        main {
            flex: 1;
            margin-top: var(--nav-height);
            padding: 40px 20px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            display: flex;
            align-items: center;
            min-height: calc(100vh - var(--nav-height));
        }
        
        /* Content Wrapper for flexible ordering */
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .content-wrapper.text-above {
            flex-direction: column-reverse;
        }
        
        /* Gallery */
        .gallery-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 40px;
        }
        
        .gallery-placeholder {
            width: 100%;
            padding-bottom: 66.67%; /* 3:2 aspect ratio */
            background-color: var(--background-color);
            position: relative;
        }
        
        .photo-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Image preloader - appears immediately */
        .image-preloader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            opacity: 0;
            transition: opacity 0.2s ease-out;
            pointer-events: none;
            z-index: 2;
        }
        
        .image-preloader.show {
            opacity: 1;
        }
        
        .image-preloader.hide {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        /* Spinner */
        .spinner {
            width: 100%;
            height: 100%;
            border: 2px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #d0d0d0;
            animation: image-spin 0.8s linear infinite;
        }
        
        @keyframes image-spin {
            to { transform: rotate(360deg); }
        }
        
        .photo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            z-index: 1;
        }
        
        .photo.active {
            opacity: 1;
        }
        
        /* Navigation Arrows - positioned at page edges on desktop */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity var(--transition-duration);
            background: none;
            border: none;
            padding: 0;
            z-index: 100;
            outline: none;
        }
        
        .nav-arrow:hover {
            opacity: 1;
        }
        
        .nav-arrow.prev {
            left: 20px;
        }
        
        .nav-arrow.next {
            right: 20px;
        }
        
        .nav-arrow svg {
            width: 100%;
            height: 100%;
            stroke: var(--text-color);
            stroke-width: 2;
            fill: none;
        }
        
        /* Mobile Navigation Controls */
        .mobile-nav-controls {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-top: 20px;
        }
        
        /* Text Content */
        .text-content {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .text-content h1, .text-content h2, .text-content h3 {
            margin: 1.5em 0 0.5em;
            font-weight: 600;
        }
        
        .text-content h1:first-child,
        .text-content h2:first-child,
        .text-content h3:first-child {
            margin-top: 0;
        }
        
        .text-content p {
            margin-bottom: 1em;
        }
        
        .text-content a {
            color: var(--text-color);
            text-decoration: underline;
        }
        
        .text-content center {
            display: block;
            text-align: center;
        }
        
        .text-content ul, .text-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        
        .text-content li {
            margin-bottom: 0.5em;
        }
        
        .text-content u {
            text-decoration: underline;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 40px 20px;
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        footer::before {
            content: var(--footer-text);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            nav {
                padding: 0 20px;
            }
            
            .nav-container {
                display: none;
            }
            
            .hamburger {
                display: block;
            }
            
            /* Hide side arrows on mobile */
            .nav-arrow {
                display: none !important;
            }
            
            /* Show mobile controls under gallery */
            .mobile-nav-controls {
                display: flex;
            }
            
            .mobile-nav-controls .nav-arrow {
                display: block !important;
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                transform: none;
                width: 36px;
                height: 36px;
            }
            
            main {
                padding: 20px 10px;
                min-height: calc(100vh - var(--nav-height));
            }
            
            .site-title {
                font-size: 1.2em;
            }
            
            /* Adjust gallery bottom margin to accommodate controls */
            .gallery-container {
                margin-bottom: 0;
            }
        }
        
        /* Touch/Swipe Support */
        .gallery-container {
            touch-action: pan-y pinch-zoom;
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Remove focus outline for mouse users, keep for keyboard */
        *:focus:not(:focus-visible) {
            outline: none;
        }
        
        *:focus-visible {
            outline: 2px solid var(--text-color);
            outline-offset: 2px;
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition-duration: 0.01ms !important;
                animation-duration: 0.01ms !important;
            }
        }
    </style>
    
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- ============================================ -->
    <!-- END OF CONFIGURATION - DO NOT EDIT BELOW     -->
    <!-- ============================================ -->
</head>
<body>
    <!-- Page Preloader - Shows immediately -->
    <div class="page-preloader" id="page-preloader">
        <div class="preloader-spinner"></div>
    </div>
    
    <!-- Main wrapper for fade-in effect -->
    <div class="main-wrapper" id="main-wrapper">
        <nav role="navigation" aria-label="Main navigation">
            <div class="nav-container" id="navigation"></div>
            <button class="hamburger" id="hamburger" aria-label="Menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a href="#" class="site-title" id="site-title" aria-label="Home"></a>
        </nav>
        
        <div class="mobile-menu" id="mobile-menu"></div>
        
        <main role="main" id="main-content">
            <!-- Content will be loaded here -->
        </main>
        
        <footer role="contentinfo"></footer>
    </div>
    
    <script>
        // Configuration for folder structure
        const CONFIG = {
            projects: [], // Will be populated dynamically
            currentProject: 'home',
            currentPhotoIndex: 0,
            photos: [],
            touchStartX: null,
            imageCache: new Map(),
            mobileMenuOpen: false,
            galleryElement: null,
            loadingAbortController: null, // For cancelling ongoing loads
            contentLoaded: false
        };
        
        // Silent fetch that doesn't log errors
        async function silentFetch(url, options = {}) {
            try {
                const response = await fetch(url, options);
                return response;
            } catch (error) {
                return { ok: false };
            }
        }
        
        // Initialize the application
        async function init() {
            try {
                await loadProjects();
                setupNavigation();
                setupMobileMenu();
                setupKeyboardNavigation();
                
                // Setup site title click
                document.getElementById('site-title').addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToProject('home');
                });
                
                // Check URL for project
                const urlParams = new URLSearchParams(window.location.search);
                const projectFromUrl = urlParams.get('project') || 'home';
                
                // Mark content as loaded and show with fade-in
                CONFIG.contentLoaded = true;
                
                // Load project from URL or default to home
                await loadProject(projectFromUrl);
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('main-content').innerHTML = '<p>Error loading content. Please ensure files are served from a web server.</p>';
                removePagePreloader();
            }
        }
        
        // Remove page preloader with fade out
        function removePagePreloader() {
            const preloader = document.getElementById('page-preloader');
            const mainWrapper = document.getElementById('main-wrapper');
            
            if (preloader && mainWrapper) {
                // Start fade in of main content
                mainWrapper.classList.add('fade-in');
                
                // Fade out preloader
                preloader.classList.add('fade-out');
                document.body.classList.add('loaded');
                
                // Remove preloader after animation
                setTimeout(() => {
                    preloader.remove();
                }, 300);
            }
        }
        
        // Navigate to project and update URL
        function navigateToProject(projectName) {
            const url = new URL(window.location);
            url.searchParams.set('project', projectName);
            window.history.pushState({project: projectName}, '', url);
            loadProject(projectName);
            
            // Remove focus from navigation elements to ensure arrow keys work
            if (document.activeElement) {
                document.activeElement.blur();
            }
        }
        
        // Load available projects from projects.txt
        async function loadProjects() {
            try {
                // Fetch the projects.txt file
                const response = await silentFetch('projects.txt');
                if (!response.ok) {
                    throw new Error('projects.txt not found');
                }
                
                const text = await response.text();
                // Split by lines and filter empty lines
                const projectFolders = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#')); // Allow comments with #
                
                // Load each project
                for (const folder of projectFolders) {
                    try {
                        // Check if it's an external link project
                        const linkResponse = await silentFetch(`${folder}/link.txt`);
                        if (linkResponse.ok) {
                            const linkUrl = (await linkResponse.text()).trim();
                            const titleResponse = await silentFetch(`${folder}/title.txt`);
                            const title = titleResponse.ok ? 
                                (await titleResponse.text()).trim().split('\n')[0] : 
                                folder.charAt(0).toUpperCase() + folder.slice(1);
                            
                            CONFIG.projects.push({ 
                                folder: folder, 
                                title: title,
                                isExternal: true,
                                link: linkUrl
                            });
                        } else {
                            // Regular project
                            const titleResponse = await silentFetch(`${folder}/title.txt`);
                            if (titleResponse.ok) {
                                const titleText = await titleResponse.text();
                                const title = titleText.trim().split('\n')[0];
                                CONFIG.projects.push({ folder: folder, title: title, isExternal: false });
                            } else {
                                CONFIG.projects.push({ 
                                    folder: folder, 
                                    title: folder.charAt(0).toUpperCase() + folder.slice(1),
                                    isExternal: false
                                });
                            }
                        }
                    } catch (e) {
                        console.warn(`Error loading project ${folder}:`, e);
                    }
                }
                
            } catch (error) {
                console.error('Error loading projects.txt:', error);
                // Fallback: try to load just 'home' if projects.txt doesn't exist
                CONFIG.projects.push({ folder: 'home', title: 'Home', isExternal: false });
            }
        }
        
        // Setup navigation menu
        function setupNavigation() {
            const nav = document.getElementById('navigation');
            const mobileMenu = document.getElementById('mobile-menu');
            nav.innerHTML = '';
            mobileMenu.innerHTML = '';
            
            CONFIG.projects.forEach(project => {
                // Skip home in navigation as it's accessible via site title
                if (project.folder === 'home') return;
                
                // Desktop nav item
                const link = document.createElement('a');
                link.className = 'nav-item';
                if (project.isExternal) {
                    link.className += ' external';
                }
                link.textContent = project.title;
                link.setAttribute('role', 'button');
                link.setAttribute('tabindex', '0');
                
                if (project.isExternal) {
                    link.onclick = (e) => {
                        e.preventDefault();
                        const openInNewTab = getComputedStyle(document.documentElement)
                            .getPropertyValue('--external-links-new-tab').trim() === 'true';
                        if (openInNewTab) {
                            window.open(project.link, '_blank', 'noopener,noreferrer');
                        } else {
                            window.location.href = project.link;
                        }
                    };
                } else {
                    link.onclick = () => {
                        navigateToProject(project.folder);
                        closeMobileMenu();
                    };
                }
                
                link.onkeypress = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        link.onclick(e);
                    }
                };
                
                if (project.folder === CONFIG.currentProject && !project.isExternal) {
                    link.classList.add('active');
                }
                
                nav.appendChild(link);
                
                // Mobile menu item
                const mobileLink = link.cloneNode(true);
                mobileLink.onclick = link.onclick;
                mobileMenu.appendChild(mobileLink);
            });
        }
        
        // Setup mobile menu
        function setupMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobile-menu');
            
            hamburger.addEventListener('click', () => {
                CONFIG.mobileMenuOpen = !CONFIG.mobileMenuOpen;
                hamburger.classList.toggle('active');
                mobileMenu.classList.toggle('active');
                hamburger.setAttribute('aria-expanded', CONFIG.mobileMenuOpen);
                
                // Prevent scrolling when menu is open
                document.body.style.overflow = CONFIG.mobileMenuOpen ? 'hidden' : '';
            });
        }
        
        function closeMobileMenu() {
            CONFIG.mobileMenuOpen = false;
            document.getElementById('hamburger').classList.remove('active');
            document.getElementById('mobile-menu').classList.remove('active');
            document.getElementById('hamburger').setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
        }
        
        // Load a specific project
        async function loadProject(projectName) {
            // Cancel any ongoing loading operations
            if (CONFIG.loadingAbortController) {
                CONFIG.loadingAbortController.abort();
            }
            
            // Create new abort controller for this load
            CONFIG.loadingAbortController = new AbortController();
            const signal = CONFIG.loadingAbortController.signal;
            
            CONFIG.currentProject = projectName;
            CONFIG.currentPhotoIndex = 0;
            CONFIG.photos = [];
            CONFIG.galleryElement = null;
            
            // Clean up any existing arrows first
            document.querySelectorAll('.nav-arrow').forEach(arrow => arrow.remove());
            document.querySelectorAll('.mobile-nav-controls').forEach(control => control.remove());
            
            // Update active navigation
            document.querySelectorAll('.nav-item').forEach((item) => {
                const project = CONFIG.projects.find(p => p.title === item.textContent);
                item.classList.toggle('active', project?.folder === projectName && !project?.isExternal);
            });
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = ''; // Clear content immediately
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'content-wrapper';
            
            // Check text position configuration
            const textPosition = getComputedStyle(document.documentElement)
                .getPropertyValue('--text-position').trim().replace(/['"]/g, '');
            if (textPosition === 'above') {
                contentWrapper.classList.add('text-above');
            }
            
            mainContent.appendChild(contentWrapper);
            
            // Load and display text content first
            let hasText = false;
            try {
                if (signal.aborted) return;
                
                const textResponse = await silentFetch(`${projectName}/text.txt`);
                if (textResponse.ok) {
                    const textContent = await textResponse.text();
                    if (textContent.trim()) {
                        hasText = true;
                        const textDiv = document.createElement('div');
                        textDiv.className = 'text-content';
                        textDiv.innerHTML = parseMarkdown(textContent);
                        contentWrapper.appendChild(textDiv);
                    }
                }
            } catch (e) {
                // No text file, that's ok
            }
            
            // Remove page preloader once text/menu is loaded
            if (CONFIG.contentLoaded) {
                removePagePreloader();
            }
            
            // Start loading photos immediately without blocking
            if (!signal.aborted) {
                loadPhotosOptimized(projectName, contentWrapper, textPosition === 'above' && hasText, signal);
            }
        }
        
        // Optimized photo loading with immediate preloader display
        async function loadPhotosOptimized(projectName, contentWrapper, insertAtEnd, signal) {
            // First try to load photos.txt for custom names
            const photosResponse = await silentFetch(`${projectName}/photos.txt`);
            if (photosResponse.ok) {
                const photosText = await photosResponse.text();
                const photoFiles = photosText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'));
                
                // Load custom photos
                for (let i = 0; i < photoFiles.length; i++) {
                    if (signal.aborted) return;
                    
                    const photoPath = `${projectName}/${photoFiles[i]}`;
                    
                    // Create gallery on first photo
                    if (i === 0) {
                        createGalleryElement(contentWrapper, insertAtEnd);
                    }
                    
                    await addPhotoToGallery(photoPath, i === 0, signal);
                    
                    // Add navigation arrows as soon as we have 2 photos
                    if (CONFIG.photos.length === 2) {
                        updateNavigationArrows();
                    }
                }
            } else {
                // Use optimized loading for standard naming pattern
                await loadStandardPhotosOptimized(projectName, contentWrapper, insertAtEnd, signal);
            }
        }
        
        // Optimized loading of standard-named photos
        async function loadStandardPhotosOptimized(projectName, contentWrapper, insertAtEnd, signal) {
            const extensions = ['jpg', 'jpeg', 'png', 'webp'];
            let foundAny = false;
            let consecutiveNotFound = 0;
            const maxConsecutiveNotFound = 3;
            const maxImages = 50;
            
            // Try loading images sequentially
            for (let i = 1; i <= maxImages && consecutiveNotFound < maxConsecutiveNotFound; i++) {
                if (signal.aborted) return;
                
                let found = false;
                
                // Try each extension
                for (const ext of extensions) {
                    const photoPath = `${projectName}/img/img${i}.${ext}`;
                    
                    // Create gallery on first attempt
                    if (!foundAny) {
                        createGalleryElement(contentWrapper, insertAtEnd);
                        foundAny = true;
                    }
                    
                    const success = await addPhotoToGallery(photoPath, CONFIG.photos.length === 0, signal);
                    
                    if (success) {
                        found = true;
                        consecutiveNotFound = 0;
                        
                        // Add navigation arrows as soon as we have 2 photos
                        if (CONFIG.photos.length === 2) {
                            updateNavigationArrows();
                        }
                        
                        break; // Found image with this extension, move to next index
                    }
                }
                
                if (!found) {
                    consecutiveNotFound++;
                }
            }
            
            // If no gallery was created (no images found), remove the empty gallery
            if (!CONFIG.photos.length && CONFIG.galleryElement) {
                CONFIG.galleryElement.remove();
                CONFIG.galleryElement = null;
            }
        }
        
        // Create the gallery element structure
        function createGalleryElement(contentWrapper, insertAtEnd) {
            const galleryHTML = `
                <div class="gallery-container" id="gallery">
                    <div class="gallery-placeholder">
                        <div class="photo-wrapper" id="photo-wrapper">
                        </div>
                    </div>
                </div>
            `;
            
            const galleryDiv = document.createElement('div');
            galleryDiv.innerHTML = galleryHTML;
            CONFIG.galleryElement = galleryDiv.firstElementChild;
            
            if (insertAtEnd) {
                contentWrapper.appendChild(CONFIG.galleryElement);
            } else {
                contentWrapper.insertBefore(CONFIG.galleryElement, contentWrapper.firstChild);
            }
        }
        
        // Add a photo to the existing gallery with immediate preloader
        async function addPhotoToGallery(photoPath, isFirst, signal) {
            return new Promise((resolve) => {
                if (signal && signal.aborted) {
                    resolve(false);
                    return;
                }
                
                const photoWrapper = document.getElementById('photo-wrapper');
                if (!photoWrapper) {
                    resolve(false);
                    return;
                }
                
                const index = CONFIG.photos.length;
                
                // Create preloader first and show it immediately for active image
                const preloader = document.createElement('div');
                preloader.className = 'image-preloader';
                preloader.dataset.index = index;
                
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                preloader.appendChild(spinner);
                
                // Add preloader to DOM
                photoWrapper.appendChild(preloader);
                
                // Show preloader immediately for first image
                if (isFirst) {
                    // Use requestAnimationFrame to ensure DOM update
                    requestAnimationFrame(() => {
                        preloader.classList.add('show');
                    });
                }
                
                // Create image element
                const img = document.createElement('img');
                img.className = 'photo';
                img.dataset.index = index;
                img.alt = `Photo ${index + 1}`;
                
                // Handle successful load
                img.onload = () => {
                    CONFIG.photos.push(photoPath);
                    
                    // Add image to DOM
                    photoWrapper.appendChild(img);
                    
                    // Activate first image with fade in
                    if (isFirst) {
                        setTimeout(() => {
                            img.classList.add('active');
                            // Hide preloader after image fades in
                            setTimeout(() => {
                                preloader.classList.add('hide');
                                setTimeout(() => {
                                    preloader.remove();
                                }, 300);
                            }, 400);
                        }, 50);
                    }
                    
                    resolve(true);
                };
                
                // Handle load error
                img.onerror = () => {
                    preloader.remove();
                    resolve(false);
                };
                
                // Handle abort
                if (signal) {
                    signal.addEventListener('abort', () => {
                        preloader.remove();
                        resolve(false);
                    });
                }
                
                // Start loading image
                img.src = photoPath;
                img.loading = isFirst ? 'eager' : 'lazy';
            });
        }
        
        // Update navigation arrows based on number of photos
        function updateNavigationArrows() {
            // Check if arrows already exist
            if (document.querySelector('.nav-arrow')) return;
            
            if (CONFIG.photos.length > 1) {
                // Desktop arrows (on sides)
                const arrowsHTML = `
                    <button class="nav-arrow prev" onclick="previousPhoto()" aria-label="Previous photo">
                        <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <button class="nav-arrow next" onclick="nextPhoto()" aria-label="Next photo">
                        <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                `;
                document.body.insertAdjacentHTML('beforeend', arrowsHTML);
                
                // Mobile controls (under gallery)
                const gallery = document.getElementById('gallery');
                if (gallery) {
                    const mobileControlsHTML = `
                        <div class="mobile-nav-controls">
                            <button class="nav-arrow prev" onclick="previousPhoto()" aria-label="Previous photo">
                                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            </button>
                            <button class="nav-arrow next" onclick="nextPhoto()" aria-label="Next photo">
                                <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </button>
                        </div>
                    `;
                    gallery.insertAdjacentHTML('afterend', mobileControlsHTML);
                }
                
                setupTouchEvents();
            }
        }
        
        // Enhanced Markdown parser
        function parseMarkdown(text) {
            // Escape HTML
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            // Process the text line by line for better control
            const lines = text.split('\n');
            let html = '';
            let inList = false;
            let inParagraph = false;
            let inCenter = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Check for center tags
                if (line.trim().toLowerCase() === '<center>') {
                    if (inParagraph) {
                        html += '</p>';
                        inParagraph = false;
                    }
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    html += '<center>';
                    inCenter = true;
                    continue;
                }
                
                if (line.trim().toLowerCase() === '</center>') {
                    html += '</center>';
                    inCenter = false;
                    continue;
                }
                
                // Headers (must be at start of line)
                if (line.match(/^#{1,6}\s/)) {
                    if (inParagraph) {
                        html += '</p>';
                        inParagraph = false;
                    }
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    
                    const level = line.match(/^(#{1,6})\s/)[1].length;
                    const content = line.replace(/^#{1,6}\s+/, '');
                    html += `<h${level}>${processInlineMarkdown(content)}</h${level}>`;
                    continue;
                }
                
                // Lists
                if (line.match(/^\*\s+/)) {
                    if (inParagraph) {
                        html += '</p>';
                        inParagraph = false;
                    }
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    const content = line.replace(/^\*\s+/, '');
                    html += `<li>${processInlineMarkdown(content)}</li>`;
                    continue;
                }
                
                // Empty line
                if (line.trim() === '') {
                    if (inParagraph && !inCenter) {
                        html += '</p>';
                        inParagraph = false;
                    }
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                // Regular paragraph
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                
                if (!inParagraph && !inCenter) {
                    html += '<p>';
                    inParagraph = true;
                }
                
                html += processInlineMarkdown(line) + ' ';
            }
            
            // Close any open tags
            if (inParagraph) html += '</p>';
            if (inList) html += '</ul>';
            
            return html;
        }
        
        // Process inline markdown (bold, italic, links, etc.)
        function processInlineMarkdown(text) {
            // Escape HTML first
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Bold + Italic (***text***)
            text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            
            // Bold (**text**)
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic (*text*)
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Underline (__text__)
            text = text.replace(/__(.*?)__/g, '<u>$1</u>');
            
            // Links with text [text](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            
            // Standalone URLs (http:// or https://)
            text = text.replace(/(^|[^"'])(https?:\/\/[^\s<]+)/g, '$1<a href="$2" target="_blank" rel="noopener">$2</a>');
            
            // Email addresses
            text = text.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1">$1</a>');
            
            // Social media handles (@username)
            text = text.replace(/(^|[^@\w])@(\w{1,15})\b/g, '$1@$2');
            
            return text;
        }
        
        // Gallery navigation functions
        function showPhoto(index) {
            const photos = document.querySelectorAll('.photo');
            const preloaders = document.querySelectorAll('.image-preloader');
            
            photos.forEach((photo, i) => {
                if (i === index) {
                    // Show preloader if image not loaded
                    const img = new Image();
                    img.onload = () => {
                        photo.classList.add('active');
                        
                        // Find and hide corresponding preloader
                        const preloader = Array.from(preloaders).find(p => p.dataset.index == i);
                        if (preloader && preloader.classList.contains('show')) {
                            setTimeout(() => {
                                preloader.classList.add('hide');
                                setTimeout(() => {
                                    preloader.remove();
                                }, 300);
                            }, 400);
                        }
                    };
                    
                    // Check if image is already loaded
                    if (photo.complete && photo.naturalHeight !== 0) {
                        photo.classList.add('active');
                    } else {
                        // Show preloader for this image
                        const preloader = Array.from(preloaders).find(p => p.dataset.index == i);
                        if (preloader && !preloader.classList.contains('show')) {
                            requestAnimationFrame(() => {
                                preloader.classList.add('show');
                            });
                        }
                        img.src = photo.src;
                    }
                } else {
                    photo.classList.remove('active');
                }
            });
            
            // Preload adjacent images
            if (index > 0 && photos[index - 1]) {
                const prevImg = new Image();
                prevImg.src = photos[index - 1].src;
            }
            if (index < photos.length - 1 && photos[index + 1]) {
                const nextImg = new Image();
                nextImg.src = photos[index + 1].src;
            }
        }
        
        function nextPhoto() {
            CONFIG.currentPhotoIndex = (CONFIG.currentPhotoIndex + 1) % CONFIG.photos.length;
            showPhoto(CONFIG.currentPhotoIndex);
        }
        
        function previousPhoto() {
            CONFIG.currentPhotoIndex = (CONFIG.currentPhotoIndex - 1 + CONFIG.photos.length) % CONFIG.photos.length;
            showPhoto(CONFIG.currentPhotoIndex);
        }
        
        // Touch event handling
        function setupTouchEvents() {
            const gallery = document.getElementById('gallery');
            if (!gallery) return;
            
            gallery.addEventListener('touchstart', handleTouchStart, { passive: true });
            gallery.addEventListener('touchmove', handleTouchMove, { passive: true });
            gallery.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        
        function handleTouchStart(e) {
            CONFIG.touchStartX = e.touches[0].clientX;
        }
        
        function handleTouchMove(e) {
            if (!CONFIG.touchStartX) return;
            
            const touchEndX = e.touches[0].clientX;
            const diff = CONFIG.touchStartX - touchEndX;
            
            // Add swipe threshold to prevent accidental swipes
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    nextPhoto();
                } else {
                    previousPhoto();
                }
                CONFIG.touchStartX = null;
            }
        }
        
        function handleTouchEnd() {
            CONFIG.touchStartX = null;
        }
        
        // Keyboard navigation
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // Check if we're in the gallery and have photos
                if (CONFIG.photos.length <= 1) return;
                
                // Always handle arrow keys for photo navigation
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousPhoto();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextPhoto();
                }
            });
        }
        
        // Start the application
        window.addEventListener('DOMContentLoaded', init);
        
        // Handle browser back/forward
        window.addEventListener('popstate', (e) => {
            const urlParams = new URLSearchParams(window.location.search);
            const project = urlParams.get('project') || 'home';
            loadProject(project);
        });
    </script>
</body>
</html>
